WITH FOL_AMOUNT AS (
    SELECT     
        MAX(FLDS.ID) AS DET_ID,
        FLDS.MAST_ID,
        NVL(SUM(FLDS.AMOUNT), 0) AS TOTAL_FOL_AMOUNT
    FROM AB_FACILITIES_LETTER_DET FLDS
    JOIN AB_LOOKUP_DETAIL LD 
        ON LD.DET_ID = FLDS.FACILITIES_ID
    WHERE FLDS.FACILITIES_TYPE = 'FACILITIES DET'
        AND FLDS.ORG_ID = :GV_ORG_ID
    GROUP BY FLDS.MAST_ID
),
ALL_EVENTS AS (
    -- Opening row
    SELECT
        FA.MAST_ID,
        NULL AS UTILIZATION_AMOUNT,
        FA.TOTAL_FOL_AMOUNT AS TOTAL_AMOUNT,
        TO_DATE('1900-01-01','YYYY-MM-DD') AS EVENT_DATE,
        0 AS EVENT_TYPE
    FROM FOL_AMOUNT FA

    UNION ALL

    -- Utilization rows (minus)
    SELECT
        FA.MAST_ID,
        AFLS.AMOUNT AS UTILIZATION_AMOUNT,
        NULL AS TOTAL_AMOUNT,
        AFLS.BG_ISSU_DATE AS EVENT_DATE,
        1 AS EVENT_TYPE
    FROM AB_FACILITIES_LETTER AFLS
    JOIN FOL_AMOUNT FA 
        ON AFLS.FACILITIES_ID = FA.DET_ID
    WHERE AFLS.ORG_ID = :GV_ORG_ID
      AND AFLS.AMOUNT > 0

    UNION ALL

    -- Return rows (plus back)
    SELECT
        FA.MAST_ID,
        NULL AS UTILIZATION_AMOUNT,
        AFLS.AMOUNT AS TOTAL_AMOUNT,
        AFLS.BG_EXPIRE_DATE AS EVENT_DATE,
        2 AS EVENT_TYPE
    FROM AB_FACILITIES_LETTER AFLS
    JOIN FOL_AMOUNT FA 
        ON AFLS.FACILITIES_ID = FA.DET_ID
    WHERE AFLS.ORG_ID = :GV_ORG_ID
      AND AFLS.BG_EXPIRE_DATE <= SYSDATE
)
SELECT
    MAST_ID,
    UTILIZATION_AMOUNT,
    TOTAL_AMOUNT,
    TO_CHAR(EVENT_DATE, 'DD-MON-YYYY') AS EVENT_DATE,
    EVENT_TYPE,
    SUM(
        CASE 
            WHEN EVENT_TYPE = 0 THEN NVL(TOTAL_AMOUNT, 0)          -- Opening (+)
            WHEN EVENT_TYPE = 1 THEN -NVL(UTILIZATION_AMOUNT, 0)   -- Utilization (âˆ’)
            WHEN EVENT_TYPE = 2 THEN NVL(TOTAL_AMOUNT, 0)           -- Return (+)
            ELSE 0
        END
    ) OVER (
        PARTITION BY MAST_ID
        ORDER BY EVENT_DATE, EVENT_TYPE
        ROWS UNBOUNDED PRECEDING
    ) AS BALANCE
FROM ALL_EVENTS

