DECLARE
  v_tax_liability NUMBER := 0;
  v_inv_net_amount NUMBER := 0;
  v_inv_bags NUMBER := 0;
  v_cprn_payments NUMBER := 0;
  v_emp_name   varchar2(200);
BEGIN

          -- Fetch employee name using P855_EMP_CODE
          BEGIN
    SELECT NVL(NAME,NULL)
    INTO v_emp_name
    FROM HR_EMPLOYEE_REGISTRATION
    WHERE HRMIS_CODE = :P855_EMP_CODE
    AND ROWNUM = 1;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      v_emp_name := NULL;
  END;
  -- JavaScript for printing and adjusting column widths
 htp.p('<script>
        function adjustColumnWidth() {
          var table = document.querySelector("table");
          var itemNameColumnIndex = 1; // Index for ITEM NAME column
          var maxWidth = 0;
          var rows = table.querySelectorAll("tbody tr");
          
          rows.forEach(function(row) {
            var itemNameCell = row.cells[itemNameColumnIndex];
            if (itemNameCell) {
              var cellWidth = itemNameCell.scrollWidth;
              if (cellWidth > maxWidth) {
                maxWidth = cellWidth;
              }
            }
          });
          
          var header = table.querySelector("thead th.item-name-column");
          if (header) {
            header.style.width = maxWidth + "px";
          }
          
          var dataCells = table.querySelectorAll("tbody td.item-name-column");
          dataCells.forEach(function(cell) {
            cell.style.width = maxWidth + "px";
          });
        }
       
        function printDiv(printpage) {
          adjustColumnWidth();
          var headstr = "<html><head><title></title><style>";
          headstr += "@page { size: A4 landscape; margin: 10mm; }";
          headstr += "body { margin: 0; padding: 0; font-family: Arial, sans-serif; }";
          headstr += ".button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }";
          headstr += ".button1 { font-size: 16px; }";
          headstr += "table { border-collapse: collapse; width: 100%; margin: 0; padding: 0; }";
          headstr += "th, td { text-align: left; padding: 3px; font-size: 10px; line-height: 1.1; }";
          headstr += "th { background-color: rgba(146, 208, 80, 0.237); -webkit-print-color-adjust: exact; print-color-adjust: exact; }";
          headstr += ".separator { border-top: 1px solid black; }";
          headstr += "h3 { margin: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(146, 208, 80); border: 1px solid black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }";
          headstr += "@media print { thead {display: table-header-group;} tfoot {display: table-footer-group;} }";
          headstr += "h2 { font-size: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; padding: 0; text-align: center; }";
          headstr += "#div_print1 { margin: 0; padding: 0; }";
          headstr += "</style></head><body>";
          var footstr = "</body></html>";
          var newstr = document.getElementById(printpage).innerHTML;
          var oldstr = document.body.innerHTML;
          document.body.innerHTML = headstr + newstr + footstr;
          window.print();
          document.body.innerHTML = oldstr;
          return false;
        }
      </script>');

  -- Print buttons for both reports
 -- htp.p('<button class="button" onclick="printDiv(''amanat_inward_report'')">Print Amanat Inward Report</button>');
  htp.p('<button class="button" onclick="printDiv(''all_reports'')">Print Reports</button>');

  -- Start merged report container
  htp.p('<div id="all_reports">');

 -- Name and logo design


htp.p('<div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">');
htp.p('<h2 style="margin: 0; font-size: 20px;">IBRAHIM TRADERS</h2>');
htp.p('<img src="#APP_FILES#WhatsApp Image 2025-08-21 at 11.35.38 AM.jpeg" alt="Logo" style="height: 40px; width: auto; object-fit: contain;">');
htp.p('</div>');

  htp.p('
<div style="font-family: Arial, sans-serif; font-size: 13px; padding: 6px; ">
   <span style="margin-right: 30px;"><b>Emp Code & Name:</b> '|| :P855_EMP_CODE || ' - ' || v_emp_name ||'</span>
   <span style="margin-right: 30px;"><b>Sub Department:</b> '|| :P855_SUB_DEPARTMENT ||'</span>
   
</div>');

  htp.p('<h3>Sub JV Salary</h3>');
  htp.p('<table>');


htp.p('<tr style="padding: 8px; text-align: center; vertical-align: middle; border: 1px solid #ddd;"> 
<th style="text-align:center;">EMP CODE</th>
<th style="text-align:center;" >EMP NAME</th>
<th style="text-align:center;" >SUB DEPARTMENT</th>
<th style="text-align:center;" >BALANCED DEBIT</th>
<th style="text-align:center;">BALANCED CREDIT</th>
<th style="text-align:center;">BALANCE</th>
</tr>');

  -- Cursor to fetch actual records — you must insert your real query here
  FOR rec IN (
        WITH emp_code AS (
    SELECT  
        NAME AS EMP_NAME,
        HRMIS_CODE,
        EMP_ID,
        SUB_DEPARTMENT
    FROM HR_EMPLOYEE_REGISTRATION
),
detail_data AS (
    SELECT 
        ASR.HRMIS_CODE,
        NVL(SUM(AFTD.DR_AMOUNT),0) AS TOTAL_DEBIT_AMOUNT,
        NVL(SUM(AFTD.CR_AMOUNT),0) AS TOTAL_CREDIT_AMOUNT,
        NVL(SUM(AFTD.DR_AMOUNT), 0) - NVL(SUM(AFTD.CR_AMOUNT), 0) AS BALANCE
    FROM AB_FIN_TRANSACTION AFT
    JOIN AB_FIN_TRANSACTION_DET AFTD 
        ON AFTD.TR_ID = AFT.TR_ID
    LEFT JOIN emp_code ASR 
        ON ASR.EMP_ID = NVL(AFTD.EMPLOYEE_REGISTRATION_ID, AFTD.HR_EMP_IDD)
    LEFT JOIN AB_LOOKUP_DETAIL ADL 
        ON ADL.DET_ID = NVL(AFTD.SALARY_ACCOUNT_ID, AFTD.ACCOUNT_TYPE_ID)
    WHERE AFT.TR_TYPE IN (801,635,628)
      AND AFTD.TRD_TYPE IN (801,635,628)
      AND AFT.org_id = :GV_ORG_ID
      AND ASR.HRMIS_CODE IS NOT NULL
      AND ASR.HRMIS_CODE = NVL(:P855_EMP_CODE, ASR.HRMIS_CODE)

      -- ✅ FIX: handle multiple sub-departments properly
      AND (
          :P855_SUB_DEPARTMENT IS NULL
          OR ASR.SUB_DEPARTMENT IN (
              SELECT TRIM(REGEXP_SUBSTR(:P855_SUB_DEPARTMENT, '[^:]+', 1, LEVEL))
              FROM dual
              CONNECT BY REGEXP_SUBSTR(:P855_SUB_DEPARTMENT, '[^:]+', 1, LEVEL) IS NOT NULL
          )
      )

      AND (
          :P855_SUB_ACC_TYPE IS NULL
          OR ADL.DET_ID IN (
              SELECT REGEXP_SUBSTR(:P855_SUB_ACC_TYPE, '[^:]+', 1, LEVEL)
              FROM dual 
              CONNECT BY REGEXP_SUBSTR(:P855_SUB_ACC_TYPE, '[^:]+', 1, LEVEL) IS NOT NULL
          )
      )
    GROUP BY ASR.HRMIS_CODE
)
SELECT
    ASR.EMP_ID,
    ASR.HRMIS_CODE AS HRMIS_CODE,
    ASR.EMP_NAME AS EMP_NAME,
    ASR.SUB_DEPARTMENT AS SUB_DEPARTMENT,
    NVL(DD.TOTAL_DEBIT_AMOUNT,0) AS BALANCED_DEBIT,
    NVL(DD.TOTAL_CREDIT_AMOUNT,0) AS BALANCED_CREDIT,
    NVL(DD.BALANCE,0) AS BALANCE,
    'DETAIL' AS DETAIL
FROM emp_code ASR
LEFT JOIN detail_data DD 
    ON DD.HRMIS_CODE = ASR.HRMIS_CODE

-- ✅ Keep same logic at outer level too
WHERE (
    :P855_SUB_DEPARTMENT IS NULL
    OR ASR.SUB_DEPARTMENT IN (
        SELECT TRIM(REGEXP_SUBSTR(:P855_SUB_DEPARTMENT, '[^:]+', 1, LEVEL))
        FROM dual
        CONNECT BY REGEXP_SUBSTR(:P855_SUB_DEPARTMENT, '[^:]+', 1, LEVEL) IS NOT NULL
    )
)
AND ASR.HRMIS_CODE = NVL(:P855_EMP_CODE, ASR.HRMIS_CODE)
ORDER BY ASR.HRMIS_CODE


  ) LOOP
    htp.p('<tr>' ||
        
          '<td style="padding: 8px; border: 1px solid #ddd;">' || rec.HRMIS_CODE || '</td>' ||
          '<td style="padding: 8px; border: 1px solid #ddd;">' || rec.EMP_NAME || '</td>' ||
          '<td style="padding: 8px; border: 1px solid #ddd;">' || rec.SUB_DEPARTMENT || '</td>' ||
          '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;">' || to_char(rec.BALANCED_DEBIT,'999G999G999G999G990D00') || '</td>' ||
          '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;">' || to_char(rec.BALANCED_CREDIT,'999G999G999G999G990D00') || '</td>' ||
          '<td style="padding: 8px; text-align: right; border: 1px solid #ddd;">' || to_char(rec.BALANCE,'999G999G999G999G990D00') || '</td>' ||
         
          '</tr>');

  
  END LOOP;

  

  htp.p('</table>');
  htp.p('</div>'); -- close all_reports
END;
----------------------------------------------------------------------------sub ledger detail report -------------------------


DECLARE
  v_tax_liability NUMBER := 0;
  v_inv_net_amount NUMBER := 0;
  v_inv_bags NUMBER := 0;
  v_cprn_payments NUMBER := 0;
  v_emp_name   varchar2(200);
  V_ACC_TYPE varchar2(200);
  v_prev_sub_type VARCHAR2(500) := NULL;
  v_first BOOLEAN := TRUE;
BEGIN
  -- Fetch employee name
  BEGIN
    SELECT NVL(NAME,NULL)
    INTO v_emp_name
    FROM HR_EMPLOYEE_REGISTRATION
    WHERE HRMIS_CODE = :P855_EMP_CODE
    AND ROWNUM = 1;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_emp_name := NULL;
  END;

  -- Fetch Account Type
  BEGIN
    SELECT LOOKUP_DET_NAME 
    INTO V_ACC_TYPE 
    FROM AB_LOOKUP_DETAIL
    WHERE DET_ID = :P855_SUB_ACC_TYPE
      AND LOOKUP_ID = 053 
      AND STATUS = 'Y'
      AND ROWNUM = 1;
  EXCEPTION WHEN NO_DATA_FOUND THEN V_ACC_TYPE := NULL;
  END;
-- JavaScript for printing and adjusting column widths
 htp.p('<script>
        function adjustColumnWidth() {
          var table = document.querySelector("table");
          var itemNameColumnIndex = 1; // Index for ITEM NAME column
          var maxWidth = 0;
          var rows = table.querySelectorAll("tbody tr");
          
          rows.forEach(function(row) {
            var itemNameCell = row.cells[itemNameColumnIndex];
            if (itemNameCell) {
              var cellWidth = itemNameCell.scrollWidth;
              if (cellWidth > maxWidth) {
                maxWidth = cellWidth;
              }
            }
          });
          
          var header = table.querySelector("thead th.item-name-column");
          if (header) {
            header.style.width = maxWidth + "px";
          }
          
          var dataCells = table.querySelectorAll("tbody td.item-name-column");
          dataCells.forEach(function(cell) {
            cell.style.width = maxWidth + "px";
          });
        }
       
        function printDiv(printpage) {
          adjustColumnWidth();
          var headstr = "<html><head><title></title><style>";
          headstr += "@page { size: A4 landscape; margin: 10mm; }";
          headstr += "body { margin: 0; padding: 0; font-family: Arial, sans-serif; }";
          headstr += ".button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }";
          headstr += ".button1 { font-size: 16px; }";
          headstr += "table { border-collapse: collapse; width: 100%; margin: 0; padding: 0; }";
          headstr += "th, td { text-align: left; padding: 3px; font-size: 10px; line-height: 1.1; }";
          headstr += "th { background-color: rgba(146, 208, 80, 0.237); -webkit-print-color-adjust: exact; print-color-adjust: exact; }";
          headstr += ".separator { border-top: 1px solid black; }";
          headstr += "h3 { margin: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(146, 208, 80); border: 1px solid black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }";
          headstr += "@media print { thead {display: table-header-group;} tfoot {display: table-footer-group;} }";
          headstr += "h2 { font-size: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; padding: 0; text-align: center; }";
          headstr += "#div_print1 { margin: 0; padding: 0; }";
          headstr += "</style></head><body>";
          var footstr = "</body></html>";
          var newstr = document.getElementById(printpage).innerHTML;
          var oldstr = document.body.innerHTML;
          document.body.innerHTML = headstr + newstr + footstr;
          window.print();
          document.body.innerHTML = oldstr;
          return false;
        }
      </script>');

 

  -- Print button & header
  htp.p('<button class="button" onclick="printDiv(''all_reports'')">Print Reports</button>');
  htp.p('<div id="all_reports">');
  htp.p('<div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <h2 style="margin: 0; font-size: 20px;">IBRAHIM TRADERS</h2>
          <img src="#APP_FILES#WhatsApp Image 2025-08-21 at 11.35.38 AM.jpeg" alt="Logo" 
               style="height: 40px; width: auto; object-fit: contain;">
         </div>');

--   htp.p('<div style="font-family: Arial, sans-serif; font-size: 13px; padding: 6px;">
--           <span style="margin-right: 30px;"><b>Emp Code & Name:</b> '|| :P855_EMP_CODE || ' - ' || v_emp_name ||'</span>
--            <span style="text-align: right;"><b>Print By:</b> '|| :APP_USER  ||'</span>
        
         
--          </div>');

htp.p('<div style="font-family: Arial, sans-serif; font-size: 13px; padding: 6px; display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span style="text-align: left;"><b>Emp Code & Name:</b> '|| :P855_EMP_CODE || ' - ' || v_emp_name ||'</span>
          <span style="text-align: right; margin-right: 40px;"><b>Print By:</b> '|| :APP_USER ||'</span>
       </div>');

      

  htp.p('<h3>Sub JV Salary</h3>');

  -- Cursor with proper ordering by SUB_ACCOUNT_TYPE
  FOR rec IN (
      WITH emp_code AS (
           SELECT 'EMP CODE # '||HRMIS_CODE||' - '|| NAME AS EMP_NAME,
                  HRMIS_CODE, EMP_ID
           FROM HR_EMPLOYEE_REGISTRATION
      ),
      USER_APPROVAL AS (
           SELECT APP_IDS AS APP_ID,
                  INITCAP(CREATED_BY) ||' ('|| TO_CHAR(CREATED_ON,'DD-MON-YYYY') ||')' APPROVED_BY,
                  APPROVAL_STATUS, CREATED_ON
           FROM AB_USER_ACTION_APPROVAL
           WHERE APP_TYPE = '780'
             AND STATUS = 'Y'
             AND APPROVAL_STATUS='APPROVED'
             AND ORG_ID=:GV_ORG_ID
      )
      SELECT 
         ASR.HRMIS_CODE,
         ASR.EMP_NAME,
         AFT.TR_DATE,
         NVL(AFTD.DR_AMOUNT,0) AS TOTAL_DEBIT_AMOUNT,
         NVL(AFTD.CR_AMOUNT,0) AS TOTAL_CREDIT_AMOUNT,
         ADL.LOOKUP_DET_NAME AS SUB_ACCOUNT_TYPE,
         AFT.VOUCHER_NAME,
         AFTD.TR_DESCRIPTION AS NARRATION
      FROM AB_FIN_TRANSACTION AFT
      LEFT JOIN AB_FIN_TRANSACTION_DET AFTD ON AFTD.TR_ID = AFT.TR_ID
      LEFT JOIN emp_code ASR ON ASR.EMP_ID = NVL(AFTD.EMPLOYEE_REGISTRATION_ID,AFTD.HR_EMP_IDD)
      LEFT JOIN AB_LOOKUP_DETAIL ADL ON ADL.DET_ID  = NVL(AFTD.SALARY_ACCOUNT_ID,AFTD.ACCOUNT_TYPE_ID)
      JOIN USER_APPROVAL UA ON UA.APP_ID = AFT.TR_ID
      WHERE AFT.TR_TYPE in (801,635,628)
        AND AFTD.TRD_TYPE in (801,635,628)
        AND (
              (AFT.VOUCHER_TYPE_ID IN (611, 613) AND NVL(AFTD.DR_AMOUNT,0) > 0)
           OR (AFT.VOUCHER_TYPE_ID IN (612, 614) AND NVL(AFTD.CR_AMOUNT,0) > 0)
           OR (AFT.VOUCHER_TYPE_ID = 799)
            )
        AND (ADL.DET_ID IN (
              SELECT REGEXP_SUBSTR(:P855_SUB_ACC_TYPE, '[^:]+', 1, LEVEL)
              FROM dual CONNECT BY REGEXP_SUBSTR(:P855_SUB_ACC_TYPE, '[^:]+', 1, LEVEL) IS NOT NULL)
             OR :P855_SUB_ACC_TYPE IS NULL)
        AND AFT.org_id = :GV_ORG_ID
        AND ASR.HRMIS_CODE = NVL(:P855_EMP_CODE,ASR.HRMIS_CODE)
      ORDER BY ADL.LOOKUP_DET_NAME, AFT.TR_DATE
  ) LOOP

    -- Check for new SUB_ACCOUNT_TYPE
    IF v_prev_sub_type IS NULL OR v_prev_sub_type <> rec.SUB_ACCOUNT_TYPE THEN
        -- Close previous table (if not first)
        IF NOT v_first THEN
            htp.p('</table>');
        END IF;
        v_first := FALSE;

        -- Start new section
        htp.p('<h4 style="background-color:rgba(146, 208, 80, 0.4);
               border:1px solid #000; padding:5px; margin:0; 
               font-size:13px; text-align:left;">
               Account Type: ' || NVL(rec.SUB_ACCOUNT_TYPE, 'N/A') || '</h4>');

        -- New table header
   -- New table header with fixed column widths
htp.p('<table style="width:100%; border-collapse:collapse; table-layout: fixed;">
      <colgroup>
         <col style="width:8%;">  
         <col style="width:9%;">   
         <col style="width:20%;">  
         <col style="width:10%;">   
         <col style="width:10%;">   
         <col style="width:23%;">   
      </colgroup>
      <tr style="background-color:rgba(146, 208, 80, 0.237); font-weight:bold; border:1px solid #000;">
        <th style="padding:5px; border:1px solid #000;">Transaction Date</th>
        <th style="padding:5px; border:1px solid #000;">Voucher Name</th>
        <th style="padding:5px; border:1px solid #000;">Emp Name</th>
        <th style="padding:5px; border:1px solid #000;">Total Debit Amount</th>
        <th style="padding:5px; border:1px solid #000;">Total Credit Amount</th>
        <th style="padding:5px; border:1px solid #000;">Debit / Credit NARRATION</th>
      </tr>');

    END IF;

    -- Print detail row
    htp.p('<tr>'||
          '<td style="padding:8px; border:1px solid #ddd;">'||to_char(rec.TR_DATE,'DD-MON-YYYY')||'</td>'||
          '<td style="padding:8px; border:1px solid #ddd;">'||rec.VOUCHER_NAME||'</td>'||
          '<td style="padding:8px; border:1px solid #ddd;">'||rec.EMP_NAME||'</td>'||
          '<td style="padding:8px; text-align:right; border:1px solid #ddd;">'||to_char(rec.TOTAL_DEBIT_AMOUNT,'999G999G999G990D00')||'</td>'||
          '<td style="padding:8px; text-align:right; border:1px solid #ddd;">'||to_char(rec.TOTAL_CREDIT_AMOUNT,'999G999G999G990D00')||'</td>'||
          '<td style="padding:8px; border:1px solid #ddd;">'||rec.NARRATION||'</td>'||
          '</tr>');

    -- Store previous subtype
    v_prev_sub_type := rec.SUB_ACCOUNT_TYPE;

  END LOOP;

  -- Close last table
  IF NOT v_first THEN
     htp.p('</table>');
  END IF;

  htp.p('</div>'); -- close all_reports

END;
